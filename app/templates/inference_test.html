{% extends "base.html" %}

{% block title %}Test Inference - Multiverse Gateway{% endblock %}

{% block content %}
<div x-data="inferenceTest()" x-init="loadModels()" class="max-w-5xl mx-auto">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900">Test Inference</h2>
        <p class="mt-2 text-sm text-gray-600">Test model inference with streaming support</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Input Panel -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white shadow sm:rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Request</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Model</label>
                        <select x-model="request.model" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <option value="">Select a model...</option>
                            <template x-for="model in models" :key="model.id">
                                <option :value="model.id" x-text="model.id"></option>
                            </template>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Message</label>
                        <textarea x-model="request.message" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter your message..."></textarea>
                    </div>

                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" x-model="request.stream" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Enable streaming</span>
                        </label>
                    </div>

                    <div>
                        <button @click="sendRequest()" :disabled="!request.model || !request.message || loading" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                            <span x-show="!loading">Send Request</span>
                            <span x-show="loading">Processing...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Response Panel -->
            <div class="bg-white shadow sm:rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Response</h3>
                <div x-show="response" class="mt-4">
                    <div class="bg-gray-50 rounded-md p-4">
                        <pre class="text-sm text-gray-900 whitespace-pre-wrap" x-text="response"></pre>
                    </div>
                </div>
                <div x-show="!response" class="text-sm text-gray-500 italic">
                    Response will appear here...
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow sm:rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Request Info</h3>
                <dl class="space-y-2 text-sm">
                    <div>
                        <dt class="text-gray-500">Status</dt>
                        <dd class="mt-1 font-medium" x-text="status"></dd>
                    </div>
                    <div x-show="latency">
                        <dt class="text-gray-500">Latency</dt>
                        <dd class="mt-1 font-medium" x-text="latency + 'ms'"></dd>
                    </div>
                    <div x-show="serverId">
                        <dt class="text-gray-500">Server ID</dt>
                        <dd class="mt-1 font-mono text-xs" x-text="serverId"></dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>
</div>

<script>
function inferenceTest() {
    return {
        models: [],
        request: { model: '', message: '', stream: false },
        response: '',
        loading: false,
        status: 'Ready',
        latency: null,
        serverId: null,

        async loadModels() {
            try {
                const data = await api.get('/v1/models');
                this.models = data.data || [];
            } catch (error) {
                toast.error('Failed to load models');
            }
        },

        async sendRequest() {
            if (!this.request.model || !this.request.message) return;
            
            this.loading = true;
            this.response = '';
            this.status = 'Sending...';
            const startTime = Date.now();

            try {
                if (this.request.stream) {
                    this.status = 'Streaming...';
                    api.createStreamingRequest(
                        '/v1/chat/completions',
                        {
                            model: this.request.model,
                            messages: [{ role: 'user', content: this.request.message }],
                            stream: true
                        },
                        (chunk) => {
                            const content = chunk.choices?.[0]?.delta?.content;
                            if (content) this.response += content;
                        },
                        () => {
                            this.latency = Date.now() - startTime;
                            this.status = 'Completed';
                            this.loading = false;
                        },
                        (error) => {
                            this.status = 'Error';
                            this.loading = false;
                            toast.error('Streaming failed: ' + error.message);
                        }
                    );
                } else {
                    const data = await api.post('/v1/chat/completions', {
                        model: this.request.model,
                        messages: [{ role: 'user', content: this.request.message }],
                        stream: false
                    });
                    this.response = data.choices[0].message.content;
                    this.latency = Date.now() - startTime;
                    this.status = 'Completed';
                    this.loading = false;
                }
            } catch (error) {
                this.status = 'Error';
                this.loading = false;
                toast.error('Request failed: ' + error.message);
            }
        }
    };
}
</script>
{% endblock %}

